(()=>{"use strict";function t(t,e,a){const s=[];for(let i=0;i<a*a-1;i++)i%a!==t&&i%a!==e||s.push(i);return s}function e(t,e,a){let s=[];for(let a=0;a<e;a++){const i=[],r=a*e;for(let t=0;t+a<=r;t=t+e-1)i.push(a+t);i.forEach((e=>{e===t&&(s=i)}))}return c(s,a,t)}function a(t,e,a){let s=[],i=e*e-e;for(let a=e-1;a<=e*e-1;a+=e){const r=[];for(let t=0;t+a<=i;t=t+e-1)r.push(a+t);i++,r.forEach((e=>{e===t&&(s=r)}))}return c(s,a,t)}function s(t,e,a){let s=[];for(let a=0;a<e;a++){const i=[],r=e*e-1-a*e;for(let t=0;t<=r;t=t+e+1)i.push(a+t);i.forEach((e=>{e===t&&(s=i)}))}return c(s,a,t)}function i(t,e,a){let s=[];for(let a=0;a<e*e-e;a+=e){const i=[],r=e*e-1-a;for(let t=0;t<=r;t=t+e+1)i.push(a+t);i.forEach((e=>{e===t&&(s=i)}))}return c(s,a,t)}function r(t,e,a){const s=[],i=t%e;for(let t=0;t<e*e-1;t++)t%e===i&&s.push(t);return c(s,a,t)}function l(t,e,a){const s=[];let i=0,r=e-1;for(;!(t<=r&&t>=i);)i+=e,r+=e;for(let t=i;t<=r;t++)s.push(t);return c(s,a,t)}function c(t,e,a){const s=[];let i,r;const l=t.findIndex((t=>t===a));i=l-e>=0?e:l,r=l+e<=t.length-1?e:t.length-1-l;for(let e=l-i;e<l;e++)s.push(t[e]);for(let e=l+1;e>l&&e<=l+r;e++)s.push(t[e]);return s}function h(t,e,a,s){let i=s;for(let s=1;s<=t&&!e.includes(i);s++)i+=a;return i}function n(t,e,a){const s=[],i=[],r=[],l=[];let c=[];for(let t=0;t<a;t++)s.push(t),i.push(t*a),r.push(t*a+(a-1)),l.push(a*a-a+t);const n=h(e,r,1,t),o=h(e,i,-1,t),m=h(e,s,-a,o);let d=h(e,l,a,o);const g=n-o+1;for(let t=0;t<g;t++){for(let e=m;e<=d;e+=a)c.push(t+e);d+=1}return c=c.filter((e=>e!=t)),c}class o{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+((e=t)>=(a=this.boardSize)*a-a?e%a==0?"bottom-left":e%a==a-1?"bottom-right":"bottom":e%a==0?e<a?"top-left":"left":e<a?e===a-1?"top-right":"top":e%a==a-1?"right":"center")),s.addEventListener("mouseenter",(t=>this.onCellEnter(t))),s.addEventListener("mouseleave",(t=>this.onCellLeave(t))),s.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(s)}var e,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const a of t){const t=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=a.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),t.appendChild(s)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(this,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t,e="yellow"){this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((a=>{const s=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class m{constructor(t){this.characters=t}}class d{constructor(t,e="generic"){if(this.level=t,this.attack=0,this.defence=0,this.health=100,this.type=e,"Character"===new.target.name)throw new Error("Нельзя создавать экземпляры данного класса.")}}class g{constructor(t,e){if(!(t instanceof d))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}function u(t,e,a,s){const i=[],r=function*(t,e){for(;;){const a=new(0,t[Math.floor(Math.random()*t.length)])(Math.ceil(Math.random()*e));yield a}}(t,e);for(let t=0;t<a;t++)i.push(r.next().value);return s&&s.forEach((t=>{i.push(t)})),new m(i)}function p(t,e){const a=new Set,s=[];for(;a.size<t.characters.length;)a.add(e[Math.floor(Math.random()*e.length)]);const i=Array.from(a);for(let e=0;e<t.characters.length;e++)s.push(new g(t.characters[e],i[e]));return s}class S extends d{constructor(t){super(t),this.attack=25,this.defence=25,this.type="bowman"}}class C extends d{constructor(t){super(t),this.attack=40,this.defence=10,this.type="swordsman"}}class y extends d{constructor(t){super(t),this.attack=10,this.defence=40,this.type="magician"}}class f extends d{constructor(t){super(t),this.attack=25,this.defence=25,this.type="vampire"}}class v extends d{constructor(t){super(t),this.attack=40,this.defence=10,this.type="undead"}}class P extends d{constructor(t){super(t),this.attack=10,this.defence=10,this.type="daemon"}}class L{constructor(){this.move="player",this.level=1,this.amountParticipants=2,this.enterIndex=null,this.enterCell=null,this.focusChar={current:!1,index:null,type:null,char:null,position:null,attack:null,move:null,cell:null},this.crtIndex=null,this.crtTypeIndex=null,this.crtCell=null,this.crtPosition=null,this.crtCharacter=null,this.crtAttack=null,this.crtMove=null,this.teamPlayers=[],this.teamCompetitors=[],this.playerTypes=[S,C,y],this.competitorTypes=[f,v,P],this.moveRangeAttack=[{name:"bowman",type:"player",move:2,attack:2},{name:"swordsman",type:"player",move:4,attack:1},{name:"magician",type:"player",move:1,attack:4},{name:"vampire",type:"competitor",move:2,attack:2},{name:"undead",type:"competitor",move:4,attack:1},{name:"daemon",type:"competitor",move:1,attack:4}],this.initPlayersPositions=null,this.initCompetitorsPositions=null}static from(t){return null}}const k=new o;k.bindToDOM(document.querySelector("#game-container"));const w=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),E=new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.gameState=new L}init(){this.gameState=new L,this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.levels();const t=u(this.gameState.playerTypes,1,this.gameState.amountParticipants),e=u(this.gameState.competitorTypes,1,this.gameState.amountParticipants);this.drawingPlayingField(t,e),this.addListeners()}levels(){switch(this.gameState.level){case 1:this.gamePlay.drawUi("prairie"),this.gameState.amountParticipants=2;break;case 2:this.gamePlay.drawUi("desert"),this.gameState.amountParticipants=3;break;case 3:this.gamePlay.drawUi("arctic"),this.gameState.amountParticipants=4;break;case 4:this.gamePlay.drawUi("mountain"),this.gameState.amountParticipants=5}}addListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}onNewGameClick(){this.init()}onSaveGameClick(){this.stateService.save(this.gameState)}onLoadGameClick(){const t=this.stateService.load();if(!t)throw new Error("Доступных сохранений нет.");this.gameState.move=t.move,this.gameState.level=t.level,this.levels(),this.gameState.teamPlayers=t.teamPlayers,this.gameState.teamCompetitors=t.teamCompetitors,this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors]),this.addListeners()}onCellEnter(t){if(this.gameState.enterIndex=t,this.gameState.enterCell=this.gamePlay.cells[this.gameState.enterIndex],document.querySelectorAll(".btn").forEach((t=>t.addEventListener("mouseover",(()=>{t.style.cursor="pointer"})))),this.gameState.enterCell.children[0]&&(this.gamePlay.showCellTooltip(this.showTooltipCharacter(t),t),this.playerOrCompetitor(this.gameState.teamCompetitors,this.gameState.enterCell,this.gameState.enterIndex)?this.gamePlay.setCursor("auto"):this.gamePlay.setCursor("pointer")),!0===this.gameState.focusChar.current){const e=this.getAllAvailableMoves(this.gameState.crtPosition,this.gameState.crtMove,this.gamePlay.boardSize);e.forEach((e=>{e!==t||this.gamePlay.cells[t].children[0]||(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(t,"green"))})),e.includes(this.gameState.enterIndex)||this.gamePlay.setCursor("auto");const a=n(this.gameState.crtIndex,this.gameState.crtAttack,this.gamePlay.boardSize);this.gameState.teamCompetitors.forEach((e=>{e.position===t&&a.includes(t)&&(this.gamePlay.selectCell(t,"red"),this.gamePlay.setCursor("crosshair")),e.position!==t||a.includes(t)||this.gamePlay.setCursor("not-allowed")}))}}showTooltipCharacter(t){const e=[...this.gameState.teamPlayers,...this.gameState.teamCompetitors].find((e=>e.position===t));if(e)return`🎖${e.character.level} ⚔${e.character.attack} 🛡${e.character.defence} ❤${e.character.health}`}async onCellClick(t){if("player"===this.gameState.move){if(this.gameState.crtIndex=t,this.setСlickСharacteristics(),"character"===this.gameState.crtTypeIndex){if(this.gameState.crtCell.className.includes("selected-yellow"))return this.gamePlay.deselectCell(this.gameState.crtIndex),this.resetFocusCharacter(),void this.setCurrentCharacteristics(null,null,null,null,null,null,null);this.gamePlay.cells.forEach(((t,e)=>this.gamePlay.deselectCell(e))),this.gamePlay.selectCell(this.gameState.crtIndex,"yellow"),this.gameState.focusChar={current:!0,index:this.gameState.crtIndex,type:this.gameState.crtTypeIndex,char:this.gameState.crtCharacter,position:this.gameState.crtPosition,attack:this.gameState.crtAttack,move:this.gameState.crtMove,cell:this.gameState.crtCell}}if("empty"===this.gameState.crtTypeIndex&&(!0===this.gameState.focusChar.current&&this.gameState.crtCell.className.includes("selected-green")?(this.gameState.focusChar.index=this.gameState.crtIndex,this.gameState.focusChar.position=this.gameState.crtIndex,this.gameState.focusChar.cell=this.gameState.crtCell,this.changeCharacterPosition(this.gameState.focusChar.char,this.gameState.crtIndex,this.gameState.teamPlayers),this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors]),this.gamePlay.cells.forEach(((t,e)=>this.gamePlay.deselectCell(e))),this.gamePlay.selectCell(this.gameState.crtIndex,"yellow"),this.setCurrentCharacteristics(this.gameState.crtIndex,this.gameState.focusChar.type,this.gameState.focusChar.char,this.gameState.focusChar.position,this.gameState.focusChar.attack,this.gameState.focusChar.move,this.gameState.focusChar.cell),this.gameState.move="competitor",this.moveCompetitor()):(this.gamePlay.cells.forEach(((t,e)=>this.gamePlay.deselectCell(e))),this.setCurrentCharacteristics(null,null,null,null,null,null,null),this.resetFocusCharacter())),"competitor"===this.gameState.crtTypeIndex)if(!0===this.gameState.focusChar.current){if(n(this.gameState.focusChar.index,this.gameState.focusChar.attack,this.gamePlay.boardSize).includes(this.gameState.crtIndex)){try{await this.attackCalculation(this.gameState.focusChar.char,this.gameState.crtCharacter,this.gameState.crtIndex)}catch(t){}"player"===this.checkNextLevel()?this.gameState.move="player":this.gameState.move="competitor",this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors])}else o.showError("Невозможно атаковать данную клетку");this.setCurrentCharacteristics(this.gameState.focusChar.index,this.gameState.focusChar.type,this.gameState.focusChar.char,this.gameState.focusChar.position,this.gameState.focusChar.attack,this.gameState.focusChar.move,this.gameState.focusChar.cell),this.moveCompetitor()}else this.resetFocusCharacter(),o.showError("Невозможно выбрать данного игрока")}}onCellLeave(t){this.gamePlay.cells[t].children[0]?(this.gamePlay.hideCellTooltip(t),this.gamePlay.setCursor("auto")):this.gamePlay.deselectCell(t),"character"===this.gameState.crtTypeIndex&&this.gameState.teamCompetitors.find((e=>e.position===t))&&(this.gamePlay.deselectCell(t),this.gamePlay.setCursor("auto")),"competitor"===this.gameState.crtTypeIndex&&this.gamePlay.deselectCell(t)}setCurrentCharacteristics(t,e,a,s,i,r,l){this.gameState.crtIndex=t,this.gameState.crtTypeIndex=e,this.gameState.crtChar=a,this.gameState.crtPosition=s,this.gameState.crtAttack=i,this.gameState.crtMove=r,this.gameState.crtCell=l}resetFocusCharacter(){this.gameState.focusChar={current:!1,index:null,type:null,char:null,position:null,attack:null,move:null,cell:null}}changeCharacterPosition(t,e,a){a.find((a=>{a.character===t&&(a.position=e)}))}async moveCompetitor(){if("competitor"===this.gameState.move&&0!=this.gameState.teamCompetitors.length){const t=this.gameState.teamCompetitors[Math.floor(Math.random()*this.gameState.teamCompetitors.length)],e=this.getCellAttack(t.character),a=n(t.position,e,this.gamePlay.boardSize),s=this.gameState.teamPlayers.filter((t=>a.includes(t.position)));if(0!==s.length){const e=s[Math.floor(Math.random()*s.length)];try{await this.attackCalculation(t.character,e.character,e.position)}catch(t){}this.checkNextLevel(),this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors])}else{let e=this.getAllAvailableMoves(this.gameState.crtPosition,this.gameState.crtMove,this.gamePlay.boardSize);e=e.filter((t=>!this.gamePlay.cells[t].children[0]));const a=e[Math.floor(Math.random()*e.length)];this.changeCharacterPosition(t.character,a,this.gameState.teamCompetitors),this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors])}this.gameState.move="player"}}async attackCalculation(t,e,a){const s=Math.round(Math.max(t.attack-e.defence,.1*t.attack));try{await this.gamePlay.showDamage(a,s)}catch(t){}e.health-=s;const i=this.isCharacterDead(e,this.gameState.teamPlayers,a);this.isCharacterDead(e,this.gameState.teamCompetitors,a),i&&!0===this.gameState.focusChar.current&&this.gameState.focusChar.char===e&&(this.resetFocusCharacter(),this.gamePlay.cells.forEach(((t,e)=>this.gamePlay.deselectCell(e))))}updateWinners(t){const e=[];return t.forEach((t=>{t.character.level>4||(t.character.level++,t.character.attack=Math.floor(Math.max(t.character.attack,t.character.attack*(80+t.character.health)/100)),t.character.defence=Math.floor(Math.max(t.character.defence,t.character.defence*(80+t.character.health)/100)),t.character.health=t.character.health+80,t.character.health>100?t.character.health=100:t.character.health),e.push(t.character)})),e}drawingPlayingField(e,a){this.gameState.initPlayersPositions=t(0,1,this.gamePlay.boardSize),this.gameState.initCompetitorsPositions=t(this.gamePlay.boardSize-1,this.gamePlay.boardSize-2,this.gamePlay.boardSize),this.gameState.teamPlayers=p(e,this.gameState.initPlayersPositions),this.gameState.teamCompetitors=p(a,this.gameState.initCompetitorsPositions),this.gamePlay.redrawPositions([...this.gameState.teamPlayers,...this.gameState.teamCompetitors])}setСlickСharacteristics(){if(this.gameState.crtCell=this.gamePlay.cells[this.gameState.crtIndex],!this.gameState.crtCell.children[0])return this.gameState.crtTypeIndex="empty",this.gameState.crtCharacter=null,this.gameState.crtPosition=null,this.gameState.crtAttack=null,void(this.gameState.crtMove=null);const t=this.playerOrCompetitor(this.gameState.teamPlayers,this.gameState.crtCell,this.gameState.crtIndex),e=this.playerOrCompetitor(this.gameState.teamCompetitors,this.gameState.crtCell,this.gameState.crtIndex);t?(this.gameState.crtTypeIndex="character",this.gameState.crtCharacter=t.character,this.gameState.crtPosition=t.position):(this.gameState.crtTypeIndex="competitor",this.gameState.crtCharacter=e.character,this.gameState.crtPosition=e.position),this.gameState.crtAttack=this.getCellAttack(this.gameState.crtCharacter),this.gameState.crtMove=this.getCellMove(this.gameState.crtCharacter)}getCellMove(t){return t?this.gameState.moveRangeAttack.find((e=>e.name===t.type)).move:null}getCellAttack(t){return t?this.gameState.moveRangeAttack.find((e=>e.name===t.type)).attack:null}checkNextLevel(){const t=this.isTeamDead(this.gameState.teamPlayers),e=this.isTeamDead(this.gameState.teamCompetitors);if(!0===t&&4===this.gameState.level||!0===e&&4===this.gameState.level||!0===t)this.gamePlay.boardEl.style.pointerEvents="none";else if(!0===e){this.gameState.level++,this.levels(),this.resetFocusCharacter();let t=this.updateWinners(this.gameState.teamPlayers);const e=this.gameState.amountParticipants-this.gameState.teamPlayers.length;t=t.map((t=>Object.setPrototypeOf(t,d.prototype)));const a=u(this.gameState.playerTypes,1,e,t),s=u(this.gameState.competitorTypes,1,this.gameState.amountParticipants);return this.drawingPlayingField(a,s),"player"}}isCharacterDead(t,e,a){let s=!1;return t.health<=0&&e.forEach(((e,i,r)=>{e.character===t&&(this.gamePlay.hideCellTooltip(a),r.splice(i,1),s=!0)})),s}isTeamDead(t){return 0===t.length}playerOrCompetitor(t,e,a){return t.find((t=>e.children[0].className.includes(t.character.type)&&t.position===a))}getAllAvailableMoves(t,c,h){return[...l(t,h,c),...r(t,h,c),...e(t,h,c),...a(t,h,c),...s(t,h,c),...i(t,h,c)]}}(k,w);E.init()})();